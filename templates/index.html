<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Track Visualizer</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .controls {
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #speed-slider {
            width: 150px;
        }

        .info {
            font-size: 14px;
            color: #333;
        }

        .boat-icon {
            text-align: center;
            font-size: 24px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading tracks...</div>
    <div id="map"></div>

    <div class="controls">
        <button id="play-btn">Play</button>
        <button id="pause-btn" disabled>Pause</button>
        <button id="reset-btn">Reset</button>

        <div class="speed-control">
            <label for="speed-slider">Speed:</label>
            <input type="range" id="speed-slider" min="1" max="10" value="5" />
            <span id="speed-value">5x</span>
        </div>

        <div class="info">
            <span id="progress-info">Ready to play</span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map;
        let tracks = [];
        let bounds = null;
        let allPoints = [];
        let currentIndex = 0;
        let animationInterval = null;
        let boatMarker = null;
        let trackPolylines = [];
        let animationPolyline = null;
        let speed = 5;

        // Initialize the map
        async function initMap() {
            try {
                // Fetch track data
                const response = await fetch('/api/tracks');
                const data = await response.json();
                tracks = data.tracks;
                bounds = data.bounds;

                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';

                // Create map centered on the tracks
                if (bounds) {
                    map = L.map('map').setView(
                        [bounds.center_lat, bounds.center_lon],
                        13
                    );
                } else {
                    map = L.map('map').setView([38.92, 20.89], 13);
                }

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Draw all tracks on the map
                tracks.forEach((track, index) => {
                    const coords = track.points.map(p => [p.lat, p.lon]);
                    const polyline = L.polyline(coords, {
                        color: getTrackColor(index),
                        weight: 2,
                        opacity: 0.6
                    }).addTo(map);
                    trackPolylines.push(polyline);

                    // Add start marker
                    if (coords.length > 0) {
                        L.circleMarker(coords[0], {
                            radius: 5,
                            color: 'green',
                            fillColor: 'green',
                            fillOpacity: 1
                        }).addTo(map).bindPopup(`Start: ${track.name}`);
                    }

                    // Add end marker
                    if (coords.length > 0) {
                        L.circleMarker(coords[coords.length - 1], {
                            radius: 5,
                            color: 'red',
                            fillColor: 'red',
                            fillOpacity: 1
                        }).addTo(map).bindPopup(`End: ${track.name}`);
                    }

                    // Collect all points for animation
                    track.points.forEach(point => {
                        allPoints.push({
                            ...point,
                            trackName: track.name
                        });
                    });
                });

                // Fit map to bounds
                if (bounds) {
                    map.fitBounds([
                        [bounds.min_lat, bounds.min_lon],
                        [bounds.max_lat, bounds.max_lon]
                    ]);
                }

                // Create boat marker (initially hidden)
                const boatIcon = L.divIcon({
                    className: 'boat-icon',
                    html: 'â›µ',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                if (allPoints.length > 0) {
                    boatMarker = L.marker(
                        [allPoints[0].lat, allPoints[0].lon],
                        { icon: boatIcon }
                    ).addTo(map);
                }

                // Initialize animation polyline
                animationPolyline = L.polyline([], {
                    color: 'blue',
                    weight: 3,
                    opacity: 0.8
                }).addTo(map);

            } catch (error) {
                console.error('Error loading tracks:', error);
                document.getElementById('loading').textContent = 'Error loading tracks!';
            }
        }

        // Get color for each track
        function getTrackColor(index) {
            const colors = [
                '#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
                '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4',
                '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3'
            ];
            return colors[index % colors.length];
        }

        // Animation functions
        function startAnimation() {
            if (animationInterval) return;

            document.getElementById('play-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            const baseDelay = 50; // Base delay in milliseconds
            const delay = baseDelay / speed;

            animationInterval = setInterval(() => {
                if (currentIndex >= allPoints.length) {
                    stopAnimation();
                    return;
                }

                const point = allPoints[currentIndex];

                // Update boat marker position
                boatMarker.setLatLng([point.lat, point.lon]);

                // Update animation trail
                const trailCoords = allPoints.slice(0, currentIndex + 1).map(p => [p.lat, p.lon]);
                animationPolyline.setLatLngs(trailCoords);

                // Update info
                const progress = ((currentIndex / allPoints.length) * 100).toFixed(1);
                document.getElementById('progress-info').textContent =
                    `Track: ${point.trackName} | Time: ${point.utc} | Progress: ${progress}%`;

                currentIndex++;
            }, delay);
        }

        function pauseAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
            }
        }

        function stopAnimation() {
            pauseAnimation();
            document.getElementById('progress-info').textContent = 'Animation complete!';
        }

        function resetAnimation() {
            pauseAnimation();
            currentIndex = 0;

            if (allPoints.length > 0) {
                boatMarker.setLatLng([allPoints[0].lat, allPoints[0].lon]);
            }

            animationPolyline.setLatLngs([]);
            document.getElementById('progress-info').textContent = 'Ready to play';
            document.getElementById('play-btn').disabled = false;
        }

        // Event listeners
        document.getElementById('play-btn').addEventListener('click', startAnimation);
        document.getElementById('pause-btn').addEventListener('click', pauseAnimation);
        document.getElementById('reset-btn').addEventListener('click', resetAnimation);

        document.getElementById('speed-slider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speed-value').textContent = `${speed}x`;

            // Restart animation with new speed if currently playing
            if (animationInterval) {
                pauseAnimation();
                startAnimation();
            }
        });

        // Initialize on page load
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
